<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solution Pattern: Cluster as a Service :: Solution Patterns for Cloud Native Architectures</title>
    <link rel="canonical" href="https://redhat-solution-patterns.github.io/solution-patterns/solution-pattern-cluster-as-a-service/04-workshop.html">
    <link rel="prev" href="03-demo.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G4SZ7DVN6E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-G4SZ7DVN6E');
</script>  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://redhat.com" target="_blank"><img
          src="../_/img/logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-solution-patterns.github.io/solution-patterns">Solution Patterns for Cloud Native Architectures</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

       
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Solution Patterns</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Adopt Change Data Capture for <br/>stack modernization</a>
            <a class="navbar-item" href="#">Edge-to-Cloud Pipelines</a>     <a class="navbar-item" href="#">Event driven architecture</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Other</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-gitops-patterns.io/">GitOps Solution Patterns</a>
            <a class="navbar-item" href="https://hybrid-cloud-patterns.io/">Hybrid Cloud Solution Patterns</a>
          </div>
        </div>

        <a class="navbar-item" target="_blank" href="https://www.redhat.com/en/products/middleware">Red Hat Application Services</a>

        <a class="navbar-item" target="_blank" href="https://developers.redhat.com/middleware">Learn more</a>

      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="solution-pattern-cluster-as-a-service" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Cluster as a Service</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">1. Home page</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#caas">1.1 What is Cluster as a Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-pattern.html#_the_solution">1.2 The solution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-architecture.html">2. Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#in_depth">2.1. An in-depth look at the solution&#8217;s architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#_more_about_the_technology_stack">2.2. More about the technology stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html">3. See the Solution in Action</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-demo.html#_demonstration">3.1. Demonstration</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-workshop.html">4. Workshop</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_installing_the_workshop_environment">4.1. Installing the workshop environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deliver_wksp">4.2. Delivering the workshop</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://redhat-solution-patterns.github.io/" target="_blank" rel="noopener">Explore Red Hat Solution Patterns</a></span>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cluster as a Service</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Cluster as a Service</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Cluster as a Service</a></li>
    <li><a href="04-workshop.html">4. Workshop</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-solution-patterns/solution-pattern-cluster-as-a-service/edit/main/documentation/modules/ROOT/pages/04-workshop.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Solution Pattern: Cluster as a Service</h1>
<div class="sect1">
<h2 id="_installing_the_workshop_environment"><a class="anchor" href="#_installing_the_workshop_environment"></a><a class="link" href="#_installing_the_workshop_environment">1. Installing the workshop environment</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this workshop we will be creating two ROSA clusters in two different AWS accounts using a Github Workflow, which is a deployment pipeline. GitHub Actions job uses Terraform code to create the clusters.</p>
</div>
<div class="paragraph">
<p>These are the requirements for the workshop:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two AWS accounts with admin privileges.</p>
</li>
<li>
<p>GitHub account and access to GitHub.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_delivering_the_workshop"><a class="anchor" href="#_delivering_the_workshop"></a><a class="link" href="#_delivering_the_workshop">2. Delivering the workshop</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>We need two AWS accounts with admin privileges to spin up an EC2 machine.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Note: If you are a Red Hatter, you can follow the below steps for getting two AWS accounts:<br>
Login to <a href="https://demo.redhat.com/catalog" class="bare">https://demo.redhat.com/catalog</a> and create the two AWS accounts using this catalog item: <a href="https://demo.redhat.com/catalog?search=aws&amp;item=babylon-catalog-prod%2Fsandboxes-gpte.sandbox-open.prod" class="bare">https://demo.redhat.com/catalog?search=aws&amp;item=babylon-catalog-prod%2Fsandboxes-gpte.sandbox-open.prod</a></p>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For each AWS account, we will be running the below steps:</p>
<div class="ulist">
<ul>
<li>
<p>Create an EC2 machine with an admin role attached to it. Ensure that ansible is installed on this machine. If using Amazon linux3, run these commands to install ansible:</p>
<div class="ulist">
<ul>
<li>
<p>sudo dnf install python3-pip</p>
</li>
<li>
<p>pip install ansible</p>
</li>
</ul>
</div>
</li>
<li>
<p>Fork this repo main branch: <a href="https://github.com/gmidha1/Terraform-code-k8s" class="bare">https://github.com/gmidha1/Terraform-code-k8s</a></p>
</li>
<li>
<p>Change the directory to playbooks.</p>
</li>
<li>
<p>Export two environment variables, where first one is aws account id and second one is aws s3 bucket, which will store our Terraform tfstate file.</p>
<div class="ulist">
<ul>
<li>
<p>AWS_ACCOUNT_ID</p>
</li>
<li>
<p>AWS_BUCKET</p>
</li>
</ul>
</div>
</li>
<li>
<p>Change the value of repo in assumeroletpl.json file.</p>
</li>
<li>
<p>Run the ansible playbook using this command: ansible-playbook ./aws-prereq.yaml . This will create the OIDC for github repo, IAM role used for GitHub workflow and S3 bucket.</p>
</li>
<li>
<p>From the output of ansible playbook command, create secrets in Github repository. Go to your repo in Github UI and go to Settings → Security → Secrets and Variables → Actions. Add/Change the value of BUCKET_TF_STATE and ROLE_ARN for the respective AWS account.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="github_secrets.png" target="_blank" rel="noopener"><img src="_images/github_secrets.png" alt="github secrets" width="100%"></a>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the pull token in the GitHub Secrets. Token is available in  <a href="https://console.redhat.com/openshift/" class="bare">https://console.redhat.com/openshift/</a></p>
</li>
<li>
<p>Now update the cluster name in these two files, commit and push the code to your forked repo.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/gmidha1/Terraform-code-k8s/blob/main/rosa-dev/cluster.tf#L80" class="bare">https://github.com/gmidha1/Terraform-code-k8s/blob/main/rosa-dev/cluster.tf#L80</a></p>
</li>
<li>
<p><a href="https://github.com/gmidha1/terraform-code-k8s/blob/main/rosa-prod/cluster.tf#L80" class="bare">https://github.com/gmidha1/terraform-code-k8s/blob/main/rosa-prod/cluster.tf#L80</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>As soon as the commit is pushed, the GitHub Actions workflow will be triggered and it will create two separate ROSA clusters in two different AWS accounts. We can see in the below image two jobs completed and created the ROSA clusters in AWS accounts.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="caas_cluster_creation.png" target="_blank" rel="noopener"><img src="_images/caas_cluster_creation.png" alt="caas cluster creation" width="100%"></a>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If we run the workflow again manually, Terraform will compare the tfstate file with code and if there are no changes, then the job will complete with no changes applied as shown below.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="caas_jobs_rerun.png" target="_blank" rel="noopener"><img src="_images/caas_jobs_rerun.png" alt="caas jobs rerun" width="100%"></a>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Two ROSA clusters are ready for use and we can deploy the applications onto these.</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-demo.html" class="query-params-link">3. See the Solution in Action</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <img
          src="../_/img/app-services-logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns"  href="https://redhat.com" ></a>
</footer><script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
